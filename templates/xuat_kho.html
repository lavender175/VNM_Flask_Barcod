{% extends "layout.html" %}

{% block body %}
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<div class="row g-4">
    <div class="col-12">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show shadow-sm fw-bold border-{{ category }}" role="alert">
                        {% if category == 'success' %}
                            <i class="bi bi-lightning-charge-fill text-warning me-2" style="font-size: 1.2rem;"></i>{% else %}
                        {% endif %}

                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>

    <div class="col-lg-4 col-md-12">
        <div class="card shadow border-0 rounded-4 mb-3">
            <div class="card-header bg-dark text-white py-3">
                <h6 class="mb-0 fw-bold"><i class="bi bi-gear-wide-connected"></i> THIẾT LẬP LỆNH</h6>
            </div>
            <div class="card-body bg-light">
                <form action="/xuat-kho" method="POST" class="mb-3">
                    <input type="hidden" name="action_type" value="LOAD_PO">
                    <label class="small fw-bold text-muted mb-1">CHỌN MÃ LỆNH SẢN XUẤT</label>
                    <div class="input-group">
                        <select class="form-select fw-bold border-primary text-primary" name="po_select" onchange="this.form.submit()">
                            <option value="" disabled {{ 'selected' if not current_po }}>-- Chọn PO --</option>
                            {% for po in po_list %}
                                <option value="{{ po }}" {{ 'selected' if current_po == po }}>{{ po }}</option>
                            {% endfor %}
                        </select>
                        <button class="btn btn-primary"><i class="bi bi-arrow-repeat"></i></button>
                    </div>
                </form>

                {% if current_po and po_requirements %}
                <div class="mt-3 border-top pt-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <label class="small fw-bold text-dark text-uppercase"><i class="bi bi-list-check"></i> Danh sách cần lấy</label>
                        <span class="badge bg-secondary">{{ po_requirements|length }} Loại</span>
                    </div>

                    <div class="list-group shadow-sm" style="max-height: 400px; overflow-y: auto;">
                        {% for sku, req_qty in po_requirements.items() %}
                            {% set cur_qty = po_progress.get(sku, 0) %}
                            {% set is_done = cur_qty >= req_qty %}

                            {% set info = sku_stock_info.get(sku, {'stock': 0, 'oldest_batch': 'N/A', 'oldest_hsd': '-'}) %}

                            <div class="list-group-item px-2 py-2 {{ 'bg-success bg-opacity-10' if is_done else '' }}">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <div class="fw-bold text-dark text-truncate small" style="max-width: 170px;" title="{{ sku }}">
                                        {% if is_done %}<i class="bi bi-check-circle-fill text-success me-1"></i>{% endif %}
                                        {{ sku }}
                                    </div>
                                    <span class="badge {{ 'bg-success' if is_done else 'bg-danger' }}">
                                        {{ cur_qty }}/{{ req_qty }}
                                    </span>
                                </div>

                                {% if not is_done %}
                                <div class="small bg-white rounded p-1 border border-warning">
                                    <div class="d-flex justify-content-between text-muted" style="font-size: 0.7rem;">
                                        <span><i class="bi bi-lightbulb-fill text-warning"></i> Gợi ý: <strong class="text-dark">{{ info.oldest_batch }}</strong></span>
                                        <span>HSD: {{ info.oldest_hsd }}</span>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                {% if current_po %}
                <div class="border-top pt-3 mt-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <label class="small fw-bold text-danger"><i class="bi bi-qr-code"></i> QUÉT MÃ ĐỂ HIỆN SP</label>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="cameraToggle" onchange="toggleCamera()">
                        </div>
                    </div>
                    <div id="reader" style="width: 100%; display: none;" class="bg-black mb-2 rounded"></div>
                    <input type="text" id="filterInput" class="form-control form-control-lg border-danger fw-bold text-center"
                           placeholder="Bắn súng quét vào đây..." onkeyup="filterItems()" autofocus autocomplete="off">
                </div>
                {% endif %}
            </div>
        </div>

        <div class="card shadow border-0 rounded-4 overflow-hidden">
            <div class="card-header bg-white py-2 d-flex justify-content-between align-items-center">
                <span class="small fw-bold text-secondary">VỪA XUẤT (SESSION)</span>
                {% if queue %}<span class="badge bg-success"><i class="bi bi-check-circle"></i> Saved</span>{% endif %}
            </div>
            <div class="list-group list-group-flush" style="max-height: 200px; overflow-y: auto;">
                {% for item in queue %}
                <div class="list-group-item d-flex justify-content-between align-items-center px-3 py-2">
                    <div>
                        <div class="fw-bold small">{{ item['SKU'] }}</div>
                        <div class="text-muted" style="font-size: 0.7rem;">{{ item['Batch'] }}</div>
                    </div>
                    <span class="badge bg-danger rounded-pill">-{{ item['Qty'] }}</span>
                </div>
                {% else %}
                <div class="text-center py-3 text-muted small fst-italic">Chưa có lịch sử xuất...</div>
                {% endfor %}
            </div>
             {% if queue %}
            <div class="card-footer bg-white p-1 text-center">
                <form action="/xuat-kho" method="POST">
                    <input type="hidden" name="action_type" value="CLEAR">
                    <button class="btn btn-link text-danger text-decoration-none small fw-bold">Xóa lịch sử phiên</button>
                </form>
            </div>
            {% endif %}
        </div>
    </div>

    <div class="col-lg-8 col-md-12">
        {% if current_po and po_requirements %}
            <div class="d-flex justify-content-between align-items-end mb-3">
                <h5 class="fw-bold text-primary mb-0"><i class="bi bi-clipboard-check"></i> TIẾN ĐỘ & XUẤT KHO</h5>
                <span class="badge bg-primary fs-6">{{ current_po }}</span>
            </div>

            <div id="waiting-screen" class="text-center py-5 bg-white rounded-4 shadow-sm border border-dashed">
                <img src="https://cdn-icons-png.flaticon.com/512/3409/3409559.png" width="80" class="mb-3 opacity-50">
                <h5 class="fw-bold text-secondary">Vui lòng quét mã sản phẩm</h5>
                <p class="small text-muted mb-0">Hệ thống sẽ tự động hiển thị thông tin khi quét đúng mã.</p>
            </div>

            <div id="bom-container">
            {% for sku, req_qty in po_requirements.items() %}
                {% set cur_qty = po_progress.get(sku, 0) %}
                {% set percent = (cur_qty / req_qty * 100)|round|int %}

                {% set stock_info = sku_stock_info.get(sku, {'stock': 0, 'oldest_batch': 'N/A', 'oldest_hsd': '-'}) %}

                <div class="card shadow-sm border-0 mb-3 item-card border-primary border-2" data-sku="{{ sku }}" style="display: none;">
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-2">
                            <div>
                                <h5 class="fw-bold text-dark mb-0"><i class="bi bi-box-seam-fill text-primary"></i> {{ sku }}</h5>
                                <small class="text-muted">
                                    Kho: <span class="fw-bold text-dark">{{ stock_info['stock'] }}</span> |
                                    FEFO: <span class="badge bg-warning text-dark border">{{ stock_info['oldest_batch'] }}</span>
                                </small>
                            </div>
                            <div class="text-end">
                                <span class="fw-bold fs-4 {{ 'text-success' if cur_qty >= req_qty else 'text-danger' }}">
                                    {{ cur_qty }} / {{ req_qty }}
                                </span>
                            </div>
                        </div>

                        <div class="progress mb-4" style="height: 8px;">
                            <div class="progress-bar {{ 'bg-success' if percent >= 100 else 'bg-warning' }}" style="width: {{ [percent, 100]|min }}%"></div>
                        </div>

                        {% if cur_qty >= req_qty %}
                            <div class="alert alert-success fw-bold text-center m-0">
                                <i class="bi bi-check-circle-fill"></i> SẢN PHẨM NÀY ĐÃ XUẤT ĐỦ!
                            </div>
                        {% else %}
                            <form action="/xuat-kho" method="POST" class="row g-2 align-items-end bg-light p-3 rounded border mx-0">
                                <input type="hidden" name="action_type" value="ADD">
                                <input type="hidden" name="mode" value="PO">
                                <input type="hidden" name="barcode_input" value="{{ sku }}">

                                <div class="col-md-5">
                                    <label class="small fw-bold text-secondary mb-1">Chọn Lô (Batch)</label>
                                    <select class="form-select fw-bold text-primary" name="manual_batch_select">
                                        {% if sku in sku_batch_options and sku_batch_options[sku] %}
                                            {% for b in sku_batch_options[sku] %}
                                                <option value="{{ b['Batch_Extract'] }}">
                                                    {{ b['Batch_Extract'] }} (HSD: {{ b['HSD'] }} | Tồn: {{ b['QtyNum'] }})
                                                    {% if loop.first %}⭐{% endif %}
                                                </option>
                                            {% endfor %}
                                        {% else %}
                                            <option value="N/A">Không tìm thấy lô (N/A)</option>
                                        {% endif %}
                                    </select>
                                </div>

                                <div class="col-6 col-md-3">
                                    <label class="small fw-bold text-secondary mb-1">Số lượng</label>
                                    <input type="number" class="form-control fw-bold text-center" name="qty" value="1" min="1" max="{{ stock_info['stock'] }}">
                                </div>

                                <div class="col-6 col-md-4 d-grid">
                                    <label class="small fw-bold text-light mb-1">.</label>
                                    <button type="submit" class="btn btn-danger fw-bold shadow-sm text-uppercase">
                                        <i class="bi bi-box-arrow-right"></i> XÁC NHẬN XUẤT
                                    </button>
                                </div>
                            </form>
                        {% endif %}

                    </div>
                </div>
            {% endfor %}
            </div>

        {% else %}
            <div class="alert alert-light text-center py-5 rounded-4 shadow-sm border">
                <i class="bi bi-arrow-left-circle fs-1 text-muted"></i>
                <h5 class="mt-3 fw-bold text-secondary">Chưa chọn Lệnh Sản Xuất</h5>
                <p class="small text-muted">Vui lòng chọn PO ở cột bên trái để bắt đầu làm việc.</p>
            </div>
        {% endif %}
    </div>
</div>

<script>
    function filterItems() {
        let input = document.getElementById('filterInput').value.toUpperCase().trim();
        let cards = document.querySelectorAll('.item-card');
        let waitingScreen = document.getElementById('waiting-screen');
        let found = false;

        if (input === "") {
            cards.forEach(card => card.style.display = "none");
            if(waitingScreen) waitingScreen.style.display = "block";
            return;
        }

        cards.forEach(card => {
            let sku = card.getAttribute('data-sku').toUpperCase();
            if (sku.indexOf(input) > -1 || input.indexOf(sku) > -1) {
                card.style.display = "block";
                card.classList.add('animate__animated', 'animate__fadeIn');
                found = true;
            } else {
                card.style.display = "none";
            }
        });

        if (found) {
            if(waitingScreen) waitingScreen.style.display = "none";
        } else {
            if(waitingScreen) waitingScreen.style.display = "block";
        }
    }

    window.onload = function() {
        let input = document.getElementById('filterInput');
        if(input) input.focus();
    };

    let html5QrcodeScanner = null;
    function toggleCamera() {
        const readerDiv = document.getElementById('reader');
        if (document.getElementById('cameraToggle').checked) {
            readerDiv.style.display = "block";
            html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
            html5QrcodeScanner.render((decodedText) => {
                document.getElementById('filterInput').value = decodedText;
                filterItems();
                new Audio('https://www.soundjay.com/button/beep-07.wav').play();
            });
        } else {
            readerDiv.style.display = "none";
            if(html5QrcodeScanner) html5QrcodeScanner.clear();
        }
    }
</script>
{% endblock %}